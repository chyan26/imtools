<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Akepa: SkyBackground::buildSkyImage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="class_sky_background.html">SkyBackground</a>      </li>
    </ul>
  </div>
<div class="contents">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_aeb77cb7f3026dc9d879889a1b645fd3e.html#aeb77cb7f3026dc9d879889a1b645fd3e">applyMasktoDetrend</a></td></tr>
          <tr><td class="navtab"><a class="qindexHL" href="class_sky_background_aa14532b4cf9575c9f549128b737a1592.html#aa14532b4cf9575c9f549128b737a1592">buildSkyImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a9919c890dbb2a278ee5e238de226368f.html#a9919c890dbb2a278ee5e238de226368f">calcQeRatio</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a158b0f5bd048727c6583bfae9609081d.html#a158b0f5bd048727c6583bfae9609081d">correctSkyLevel</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_af1b36fea8a8f9157061a4c3f143bb61e.html#af1b36fea8a8f9157061a4c3f143bb61e">DetrendFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_affa09bc7003918dcad45b2b2784d6507.html#affa09bc7003918dcad45b2b2784d6507">FileList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a5a571e4c32175c9cf5a243460f2d16fa.html#a5a571e4c32175c9cf5a243460f2d16fa">getDetrendFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_aa0d7646b74a3454b113fa42b6490ba7e.html#aa0d7646b74a3454b113fa42b6490ba7e">getFileList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665">getMaskFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a373deff1f72723387cd40f3d390bb4f2.html#a373deff1f72723387cd40f3d390bb4f2">getMaskList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a53e4e84a93f5fe68e4213a32552d8955.html#a53e4e84a93f5fe68e4213a32552d8955">getNMaskFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a2e6e9bdd1501e3239922d25496554751.html#a2e6e9bdd1501e3239922d25496554751">getNSkyFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a33b73e66163f007444a87988182a57d3.html#a33b73e66163f007444a87988182a57d3">getTotalFrameNumber</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a9eb06eb7f5217744bad686e5ace0a7db.html#a9eb06eb7f5217744bad686e5ace0a7db">MaskFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_afe4e3242a5649339cbdd3352d8699efa.html#afe4e3242a5649339cbdd3352d8699efa">MaskList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a8598db4f63fb37f7f8b50e2a8bd375ca.html#a8598db4f63fb37f7f8b50e2a8bd375ca">nMaskFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a5e3f459ec6bb17b89602626cbe5b11ce.html#a5e3f459ec6bb17b89602626cbe5b11ce">parseList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a6f93826880e93e87f29c7ca9fed22619.html#a6f93826880e93e87f29c7ca9fed22619">setDetrendFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a6e81521e69e534f9522ee0d6ad5ce1ed.html#a6e81521e69e534f9522ee0d6ad5ce1ed">setDetrendImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a1ff3d7d529d8d7cbdee5e9e3c317ca36.html#a1ff3d7d529d8d7cbdee5e9e3c317ca36">setFileList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_aeb64f5dea2ddfb98760b99cef8750e4f.html#aeb64f5dea2ddfb98760b99cef8750e4f">setMaskFile</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a50d7fd7da9f930b1af73fa2e8a644109.html#a50d7fd7da9f930b1af73fa2e8a644109">setMaskImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_adac86077fdc277287ed3809e6c54ffcc.html#adac86077fdc277287ed3809e6c54ffcc">setMaskList</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a00e361efcefe8fe9eb2fd8dba080fd5e.html#a00e361efcefe8fe9eb2fd8dba080fd5e">setNMaskFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_ae70470f15b4db1c0d2ddfc97616d4329.html#ae70470f15b4db1c0d2ddfc97616d4329">setNSkyFITS</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_ad6d664613db7e0fe3e26a00109fee27e.html#ad6d664613db7e0fe3e26a00109fee27e">setTotalFrameNumber</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a851efe362ae56e4f68184adc0f06708e.html#a851efe362ae56e4f68184adc0f06708e">SkyBackground</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a97bae057fbff40d0a1755e9808ff8928.html#a97bae057fbff40d0a1755e9808ff8928">SkyBackground</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a6f67098502bb2edab87b45ed6dad5e9b.html#a6f67098502bb2edab87b45ed6dad5e9b">SkyBackground</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a0149941a484570d87b3ef9673a5f429c.html#a0149941a484570d87b3ef9673a5f429c">writeSkyBackgroundImage</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="class_sky_background_a90e0f18376871dd8e72b1b06b263c3b3.html#a90e0f18376871dd8e72b1b06b263c3b3">~SkyBackground</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top">
<a class="anchor" id="aa14532b4cf9575c9f549128b737a1592"></a><!-- doxytag: member="SkyBackground::buildSkyImage" ref="aa14532b4cf9575c9f549128b737a1592" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SkyBackground::buildSkyImage </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Building sky image. </p>

<p><p>The value of each pixel is normalized with exposure time and sky variance. This step is used for correction the difference between sky levels.</p>
<p>take median value of all images as sky background</p>
<p>Go through all slices</p>
<p>Picking-up all pixels that are not marked by NaN, -CHIPBIAS or any negative value.</p>
<p>Normalize sky background to 1 </p>
</p>

<p>Definition at line <a class="el" href="skybackground_8cpp_source.html#l00262">262</a> of file <a class="el" href="skybackground_8cpp_source.html">skybackground.cpp</a>.</p>

<p><div class="fragment"><pre class="fragment">                                 {
        <span class="keywordtype">int</span> fits,ext,slice,offset,j,nslice,i=0;
        <span class="keywordtype">double</span> arr[<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>];
        <span class="keywordtype">double</span> temp[<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize];
        <span class="keywordtype">double</span> value,med,factor;

        offset=<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;

        <span class="comment">/* Correcting sky variance*/</span>
        <span class="keywordflow">for</span> (fits=0;fits&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;fits++){
                nslice=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
                <span class="keywordflow">for</span> (slice=0;slice&lt;nslice;slice++){
                        factor=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_a07f6264ce16923314276990bf5d4898d.html#a07f6264ce16923314276990bf5d4898d" title="Exposure time.">exptime</a>*<a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>[i];
                        <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
                                <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
                                        value=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a5d453cb18689cc8264fe941a13901be1.html#a5d453cb18689cc8264fe941a13901be1">getImageArrayValue</a>((ext*nslice+slice)*offset+j)/factor;
                                        <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a059d8d62a754e6f33ff3fd8b3d521671.html#a059d8d62a754e6f33ff3fd8b3d521671">setImageArrayValue</a>((ext*nslice+slice)*offset+j,value);
                                }
                        }
                        <span class="comment">//printf(&quot;I=%i SKYLVL=%f exp=%f fac=%f\n&quot;,i,skylvl_var[i],DetrendImage[fits].getImageHeader().exptime,factor);</span>
                        i++;
                }
        }
        <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
                <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
                        i=0;
                        <span class="keywordflow">for</span> (fits=0;fits&lt;nSkyFITS;fits++){
                                nslice=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
                                <span class="keywordflow">for</span> (slice=0;slice&lt;nslice;slice++){
                                        <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].getImageArrayValue((ext*nslice+slice)*offset+j) &lt;= 0){<span class="keywordflow">continue</span>;}
                                        arr[i]=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a5d453cb18689cc8264fe941a13901be1.html#a5d453cb18689cc8264fe941a13901be1">getImageArrayValue</a>((ext*nslice+slice)*offset+j);
                                        i++;
                                }
                        }
                        <span class="keywordflow">if</span> (i == 0 ){
                                <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[ext*offset+j]=0;
                        } <span class="keywordflow">else</span> {
                                <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[ext*offset+j]=<a class="code" href="calculate_8cpp_aca87034f5f258906fac666feb24c63de.html#aca87034f5f258906fac666feb24c63de">GetMedian</a>(arr,i);
                        }
                }
        }
        <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
                offset=ext*<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;
                <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
                        temp[j]=<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j];
                }

                med=<a class="code" href="calculate_8cpp_aca87034f5f258906fac666feb24c63de.html#aca87034f5f258906fac666feb24c63de">GetMedian</a>(temp,<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize);

<span class="preprocessor">                #ifdef DEBUG</span>
<span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;med=%f\n&quot;</span>,med);
<span class="preprocessor">                #endif</span>
<span class="preprocessor"></span>
                <span class="comment">/* Normalize sky background to unity */</span>
                <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
                        <span class="keywordflow">if</span> (isnan(<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]) ||<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j] &lt;= 0){
                                <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]=nanf(<span class="stringliteral">&quot;NaN&quot;</span>);
                        }
                        <span class="keywordflow">else</span>{
                                <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]=<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]/med;
                        }
                }
        }



}
</pre></div></p>

</div>
</div>
    </td>
  </tr>
</table>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Fri Jul 22 2011 20:18:24 for Akepa by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
