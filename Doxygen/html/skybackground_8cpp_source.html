<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Akepa: skybackground.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_a7a489861bc54f8c2d646466d01a36ed.html">src</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>skybackground.cpp</h1>  </div>
</div>
<div class="contents">
<a href="skybackground_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;libgen.h&gt;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;fitsio.h&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="image_8h.html" title="This class defines the basic operations for FITS image.">image.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="calculate_8h.html" title="Created on: Aug 17, 2010 Author: chyan.">calculate.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="skybackground_8h.html">skybackground.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="imparameter_8h.html">imparameter.h</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="keyword">using namespace </span>std;
<a name="l00024"></a>00024 
<a name="l00028"></a><a class="code" href="class_sky_background_a1ff3d7d529d8d7cbdee5e9e3c317ca36.html#a1ff3d7d529d8d7cbdee5e9e3c317ca36">00028</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a1ff3d7d529d8d7cbdee5e9e3c317ca36.html#a1ff3d7d529d8d7cbdee5e9e3c317ca36" title="Set the file list for skybackground.">SkyBackground::setFileList</a>(<span class="keywordtype">char</span>* list){
<a name="l00029"></a>00029         <a class="code" href="class_sky_background_affa09bc7003918dcad45b2b2784d6507.html#affa09bc7003918dcad45b2b2784d6507">FileList</a> = list;
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00035"></a><a class="code" href="class_sky_background_aa0d7646b74a3454b113fa42b6490ba7e.html#aa0d7646b74a3454b113fa42b6490ba7e">00035</a> <span class="keywordtype">char</span>* <a class="code" href="class_sky_background_aa0d7646b74a3454b113fa42b6490ba7e.html#aa0d7646b74a3454b113fa42b6490ba7e" title="Get the file list for skybackground.">SkyBackground::getFileList</a>(){
<a name="l00036"></a>00036         <span class="keywordflow">return</span> <a class="code" href="class_sky_background_affa09bc7003918dcad45b2b2784d6507.html#affa09bc7003918dcad45b2b2784d6507">FileList</a>;
<a name="l00037"></a>00037 }
<a name="l00038"></a>00038 
<a name="l00042"></a><a class="code" href="class_sky_background_adac86077fdc277287ed3809e6c54ffcc.html#adac86077fdc277287ed3809e6c54ffcc">00042</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_adac86077fdc277287ed3809e6c54ffcc.html#adac86077fdc277287ed3809e6c54ffcc" title="Set the file list for bad pixel mask.">SkyBackground::setMaskList</a>(<span class="keywordtype">char</span>* list){
<a name="l00043"></a>00043         <a class="code" href="class_sky_background_afe4e3242a5649339cbdd3352d8699efa.html#afe4e3242a5649339cbdd3352d8699efa">MaskList</a> = list;
<a name="l00044"></a>00044 }
<a name="l00045"></a>00045 
<a name="l00049"></a><a class="code" href="class_sky_background_a373deff1f72723387cd40f3d390bb4f2.html#a373deff1f72723387cd40f3d390bb4f2">00049</a> <span class="keywordtype">char</span>* <a class="code" href="class_sky_background_a373deff1f72723387cd40f3d390bb4f2.html#a373deff1f72723387cd40f3d390bb4f2" title="Get the file list for bad pixel mask.">SkyBackground::getMaskList</a>(){
<a name="l00050"></a>00050         <span class="keywordflow">return</span> <a class="code" href="class_sky_background_afe4e3242a5649339cbdd3352d8699efa.html#afe4e3242a5649339cbdd3352d8699efa">MaskList</a>;
<a name="l00051"></a>00051 }
<a name="l00055"></a><a class="code" href="class_sky_background_ae70470f15b4db1c0d2ddfc97616d4329.html#ae70470f15b4db1c0d2ddfc97616d4329">00055</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_ae70470f15b4db1c0d2ddfc97616d4329.html#ae70470f15b4db1c0d2ddfc97616d4329" title="Set the number of sky frames based on input files.">SkyBackground::setNSkyFITS</a>(<span class="keywordtype">int</span> nsky){
<a name="l00056"></a>00056         <a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>=nsky;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00062"></a><a class="code" href="class_sky_background_a2e6e9bdd1501e3239922d25496554751.html#a2e6e9bdd1501e3239922d25496554751">00062</a> <span class="keywordtype">int</span> <a class="code" href="class_sky_background_a2e6e9bdd1501e3239922d25496554751.html#a2e6e9bdd1501e3239922d25496554751" title="Get the number of sky frames.">SkyBackground::getNSkyFITS</a>(){
<a name="l00063"></a>00063         <span class="keywordflow">return</span> <a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;
<a name="l00064"></a>00064 }
<a name="l00068"></a><a class="code" href="class_sky_background_a00e361efcefe8fe9eb2fd8dba080fd5e.html#a00e361efcefe8fe9eb2fd8dba080fd5e">00068</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a00e361efcefe8fe9eb2fd8dba080fd5e.html#a00e361efcefe8fe9eb2fd8dba080fd5e" title="Set the number of bad pixel frames based on input files.">SkyBackground::setNMaskFITS</a>(<span class="keywordtype">int</span> nsky){
<a name="l00069"></a>00069         <a class="code" href="class_sky_background_a8598db4f63fb37f7f8b50e2a8bd375ca.html#a8598db4f63fb37f7f8b50e2a8bd375ca">nMaskFITS</a>=nsky;
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00075"></a><a class="code" href="class_sky_background_a53e4e84a93f5fe68e4213a32552d8955.html#a53e4e84a93f5fe68e4213a32552d8955">00075</a> <span class="keywordtype">int</span> <a class="code" href="class_sky_background_a53e4e84a93f5fe68e4213a32552d8955.html#a53e4e84a93f5fe68e4213a32552d8955" title="Get the number of bad pixel frames.">SkyBackground::getNMaskFITS</a>(){
<a name="l00076"></a>00076         <span class="keywordflow">return</span> <a class="code" href="class_sky_background_a8598db4f63fb37f7f8b50e2a8bd375ca.html#a8598db4f63fb37f7f8b50e2a8bd375ca">nMaskFITS</a>;
<a name="l00077"></a>00077 }
<a name="l00081"></a><a class="code" href="class_sky_background_a6f93826880e93e87f29c7ca9fed22619.html#a6f93826880e93e87f29c7ca9fed22619">00081</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a6f93826880e93e87f29c7ca9fed22619.html#a6f93826880e93e87f29c7ca9fed22619" title="Setting an array for storing detrend FITS files.">SkyBackground::setDetrendFile</a>(<span class="keywordtype">char</span>* list){
<a name="l00082"></a>00082         <span class="keywordtype">int</span> n=0;
<a name="l00083"></a>00083         <a class="code" href="class_sky_background_a5e3f459ec6bb17b89602626cbe5b11ce.html#a5e3f459ec6bb17b89602626cbe5b11ce" title="Parse the string list to array.">parseList</a>(this-&gt;<a class="code" href="class_sky_background_affa09bc7003918dcad45b2b2784d6507.html#affa09bc7003918dcad45b2b2784d6507">FileList</a>,<a class="code" href="class_sky_background_af1b36fea8a8f9157061a4c3f143bb61e.html#af1b36fea8a8f9157061a4c3f143bb61e">DetrendFile</a>,&amp;n);
<a name="l00084"></a>00084         <a class="code" href="class_sky_background_ae70470f15b4db1c0d2ddfc97616d4329.html#ae70470f15b4db1c0d2ddfc97616d4329" title="Set the number of sky frames based on input files.">setNSkyFITS</a>(n);
<a name="l00085"></a>00085 }
<a name="l00089"></a><a class="code" href="class_sky_background_a5a571e4c32175c9cf5a243460f2d16fa.html#a5a571e4c32175c9cf5a243460f2d16fa">00089</a> <span class="keywordtype">char</span>* <a class="code" href="class_sky_background_a5a571e4c32175c9cf5a243460f2d16fa.html#a5a571e4c32175c9cf5a243460f2d16fa" title="getting the name of detrended FITS file based on array index">SkyBackground::getDetrendFile</a>(<span class="keywordtype">int</span> i){
<a name="l00090"></a>00090         <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_sky_background_af1b36fea8a8f9157061a4c3f143bb61e.html#af1b36fea8a8f9157061a4c3f143bb61e">DetrendFile</a>[i];
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00096"></a><a class="code" href="class_sky_background_aeb64f5dea2ddfb98760b99cef8750e4f.html#aeb64f5dea2ddfb98760b99cef8750e4f">00096</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_aeb64f5dea2ddfb98760b99cef8750e4f.html#aeb64f5dea2ddfb98760b99cef8750e4f" title="Setting an array for storing bad pixel masks.">SkyBackground::setMaskFile</a>(<span class="keywordtype">char</span>* list){
<a name="l00097"></a>00097         <span class="keywordtype">int</span> n=0;
<a name="l00098"></a>00098         <a class="code" href="class_sky_background_a5e3f459ec6bb17b89602626cbe5b11ce.html#a5e3f459ec6bb17b89602626cbe5b11ce" title="Parse the string list to array.">parseList</a>(this-&gt;<a class="code" href="class_sky_background_afe4e3242a5649339cbdd3352d8699efa.html#afe4e3242a5649339cbdd3352d8699efa">MaskList</a>,<a class="code" href="class_sky_background_a9eb06eb7f5217744bad686e5ace0a7db.html#a9eb06eb7f5217744bad686e5ace0a7db">MaskFile</a>,&amp;n);
<a name="l00099"></a>00099         <a class="code" href="class_sky_background_a00e361efcefe8fe9eb2fd8dba080fd5e.html#a00e361efcefe8fe9eb2fd8dba080fd5e" title="Set the number of bad pixel frames based on input files.">setNMaskFITS</a>(n);
<a name="l00100"></a>00100 }
<a name="l00104"></a><a class="code" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665">00104</a> <span class="keywordtype">char</span>* <a class="code" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665" title="Getting the name of bad pixel masks based on array index.">SkyBackground::getMaskFile</a>(<span class="keywordtype">int</span> i){
<a name="l00105"></a>00105         <span class="keywordflow">return</span> this-&gt;<a class="code" href="class_sky_background_a9eb06eb7f5217744bad686e5ace0a7db.html#a9eb06eb7f5217744bad686e5ace0a7db">MaskFile</a>[i];
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00111"></a><a class="code" href="class_sky_background_a6e81521e69e534f9522ee0d6ad5ce1ed.html#a6e81521e69e534f9522ee0d6ad5ce1ed">00111</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a6e81521e69e534f9522ee0d6ad5ce1ed.html#a6e81521e69e534f9522ee0d6ad5ce1ed" title="Setting image objects for sky frames.">SkyBackground::setDetrendImage</a>(){
<a name="l00112"></a>00112         <span class="keywordtype">int</span> n=0;
<a name="l00113"></a>00113         <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a> = <span class="keyword">new</span> <a class="code" href="class_image.html" title="The basic images class of image operation.">Image</a>[<a class="code" href="class_sky_background_a2e6e9bdd1501e3239922d25496554751.html#a2e6e9bdd1501e3239922d25496554751" title="Get the number of sky frames.">getNSkyFITS</a>()];
<a name="l00114"></a>00114         <span class="keywordflow">for</span> (n=0;n&lt;this-&gt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;n++){
<a name="l00115"></a>00115                 <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a1122dab3409c409b5693e08a8476599b.html#a1122dab3409c409b5693e08a8476599b" title="This is a object initializer other than default constructor.">setImage</a>(<a class="code" href="class_sky_background_a5a571e4c32175c9cf5a243460f2d16fa.html#a5a571e4c32175c9cf5a243460f2d16fa" title="getting the name of detrended FITS file based on array index">getDetrendFile</a>(n));
<a name="l00116"></a>00116                 cout &lt;&lt; <span class="stringliteral">&quot;Loading &quot;</span>&lt;&lt; <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_aca3edfeb22cfb20a20a8014e39cc77aa.html#aca3edfeb22cfb20a20a8014e39cc77aa" title="Get the filename in this class.">getFilename</a>()&lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00117"></a>00117         }
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00123"></a><a class="code" href="class_sky_background_a50d7fd7da9f930b1af73fa2e8a644109.html#a50d7fd7da9f930b1af73fa2e8a644109">00123</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a50d7fd7da9f930b1af73fa2e8a644109.html#a50d7fd7da9f930b1af73fa2e8a644109" title="Setting image objects for mask/bad pixel files.">SkyBackground::setMaskImage</a>(){
<a name="l00124"></a>00124         <span class="keywordtype">int</span> n;
<a name="l00125"></a>00125         <a class="code" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a> = <span class="keyword">new</span> <a class="code" href="class_image.html" title="The basic images class of image operation.">Image</a>[<a class="code" href="class_sky_background_a53e4e84a93f5fe68e4213a32552d8955.html#a53e4e84a93f5fe68e4213a32552d8955" title="Get the number of bad pixel frames.">getNMaskFITS</a>()];
<a name="l00126"></a>00126         <span class="keywordflow">for</span> (n=0;n&lt;this-&gt;<a class="code" href="class_sky_background_a8598db4f63fb37f7f8b50e2a8bd375ca.html#a8598db4f63fb37f7f8b50e2a8bd375ca">nMaskFITS</a>;n++){
<a name="l00127"></a>00127                 <a class="code" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a>[n].<a class="code" href="class_image_a1122dab3409c409b5693e08a8476599b.html#a1122dab3409c409b5693e08a8476599b" title="This is a object initializer other than default constructor.">setImage</a>(<a class="code" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665" title="Getting the name of bad pixel masks based on array index.">getMaskFile</a>(n));
<a name="l00128"></a>00128                 cout &lt;&lt; <span class="stringliteral">&quot;Loading &quot;</span>&lt;&lt; <a class="code" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665" title="Getting the name of bad pixel masks based on array index.">getMaskFile</a>(n)&lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="class_sky_background_ad6d664613db7e0fe3e26a00109fee27e.html#ad6d664613db7e0fe3e26a00109fee27e">00133</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_ad6d664613db7e0fe3e26a00109fee27e.html#ad6d664613db7e0fe3e26a00109fee27e">SkyBackground::setTotalFrameNumber</a>(){
<a name="l00134"></a>00134         <span class="keywordtype">int</span> i;
<a name="l00135"></a>00135         <a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>=0;
<a name="l00136"></a>00136         <span class="keywordflow">for</span> (i=0;i&lt;this-&gt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;i++){
<a name="l00137"></a>00137                 <a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>=<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>+<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[i].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="class_sky_background_a33b73e66163f007444a87988182a57d3.html#a33b73e66163f007444a87988182a57d3">00141</a> <span class="keywordtype">int</span> <a class="code" href="class_sky_background_a33b73e66163f007444a87988182a57d3.html#a33b73e66163f007444a87988182a57d3">SkyBackground::getTotalFrameNumber</a>(){
<a name="l00142"></a>00142         <span class="keywordflow">return</span> <a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>;
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00148"></a><a class="code" href="class_sky_background_a5e3f459ec6bb17b89602626cbe5b11ce.html#a5e3f459ec6bb17b89602626cbe5b11ce">00148</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a5e3f459ec6bb17b89602626cbe5b11ce.html#a5e3f459ec6bb17b89602626cbe5b11ce" title="Parse the string list to array.">SkyBackground::parseList</a>(<span class="keywordtype">char</span> *liststr,<span class="keywordtype">char</span>* filelist[], <span class="keywordtype">int</span>* n){
<a name="l00149"></a>00149         <span class="keywordtype">int</span> i=0;
<a name="l00150"></a>00150         <span class="keywordtype">char</span>* pch;
<a name="l00151"></a>00151         pch = strtok (liststr,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l00152"></a>00152         filelist[i]=pch;
<a name="l00153"></a>00153         <span class="keywordflow">while</span> (pch != NULL){
<a name="l00154"></a>00154                 filelist[i]=pch;
<a name="l00155"></a>00155                 pch = strtok (NULL, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00156"></a>00156                 i++;
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158         *n=i;
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00164"></a><a class="code" href="class_sky_background_aeb77cb7f3026dc9d879889a1b645fd3e.html#aeb77cb7f3026dc9d879889a1b645fd3e">00164</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_aeb77cb7f3026dc9d879889a1b645fd3e.html#aeb77cb7f3026dc9d879889a1b645fd3e" title="This function is used for apply bad pixel to detrend data.">SkyBackground::applyMasktoDetrend</a>(){
<a name="l00165"></a>00165         <span class="keywordtype">int</span> n,i,size;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="preprocessor">        #ifdef DEBUG</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;Masking flatten images.\n&quot;</span>);
<a name="l00169"></a>00169 <span class="preprocessor">        #endif</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172         <span class="keywordflow">for</span> (n=0;n&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;n++){
<a name="l00173"></a>00173                 <a class="code" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a> = <span class="keyword">new</span> <a class="code" href="class_image.html" title="The basic images class of image operation.">Image</a>(<a class="code" href="class_sky_background_af6b274b2d2c51cc4bd4f8154bdcaf665.html#af6b274b2d2c51cc4bd4f8154bdcaf665" title="Getting the name of bad pixel masks based on array index.">getMaskFile</a>(n));
<a name="l00175"></a>00175                 <span class="comment">//MaskImage-&gt;setImage(getMaskFile(n));</span>
<a name="l00176"></a>00176                 size=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_a59ee537d1d195f29bfeafcc52351209b.html#a59ee537d1d195f29bfeafcc52351209b" title="Number of total extensions in FITS image.">nextend</a>*<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_af18827a7dba925a3612a67838ff5ea4f.html#af18827a7dba925a3612a67838ff5ea4f" title="Dimension of X-axis.">naxis1</a>*
<a name="l00177"></a>00177                                 <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_a17b1ed333dd52123062e2feae02ef0c5.html#a17b1ed333dd52123062e2feae02ef0c5" title="Dimension of Y-axis.">naxis2</a>*<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
<a name="l00178"></a>00178                 <span class="keywordflow">for</span> (i=0;i&lt;size;i++){
<a name="l00179"></a>00179                         <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a>-&gt;<a class="code" href="class_image_a5d453cb18689cc8264fe941a13901be1.html#a5d453cb18689cc8264fe941a13901be1">getImageArrayValue</a>(i) == 0){
<a name="l00180"></a>00180                                 <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[n].<a class="code" href="class_image_a059d8d62a754e6f33ff3fd8b3d521671.html#a059d8d62a754e6f33ff3fd8b3d521671">setImageArrayValue</a>(i,0);
<a name="l00181"></a>00181                         }
<a name="l00182"></a>00182                 }
<a name="l00183"></a>00183                 <span class="keyword">delete</span>(<a class="code" href="class_sky_background_af0dbe368b61cc33944633dee53f6312e.html#af0dbe368b61cc33944633dee53f6312e">MaskImage</a>);
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00190"></a><a class="code" href="class_sky_background_a9919c890dbb2a278ee5e238de226368f.html#a9919c890dbb2a278ee5e238de226368f">00190</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a9919c890dbb2a278ee5e238de226368f.html#a9919c890dbb2a278ee5e238de226368f" title="This function calculate QE ration for each chip using skyrate.">SkyBackground::calcQeRatio</a>(){
<a name="l00191"></a>00191 
<a name="l00192"></a>00192         <span class="keywordtype">int</span> i=0,fits=0,slice=0;
<a name="l00193"></a>00193         <span class="keywordtype">int</span> ext=0;
<a name="l00194"></a>00194         <span class="keywordtype">double</span> temp=0;
<a name="l00195"></a>00195         <span class="keywordtype">double</span> *arr=NULL;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197         arr=(<span class="keywordtype">double</span> *)malloc(<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00200"></a>00200                 i=0;
<a name="l00201"></a>00201                 <span class="keywordflow">for</span> (fits=0;fits&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;fits++){
<a name="l00202"></a>00202                         <span class="keywordflow">for</span> (slice=0;slice&lt;<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;slice++){
<a name="l00203"></a>00203                                 arr[i]=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a83b2c1bbcdf13ce05854d06585ccae5a.html#a83b2c1bbcdf13ce05854d06585ccae5a" title="This function is used to get the sky level of each frame.">getImageMedian</a>()[slice].<a class="code" href="structskybackground__t_aef9a60e9d1c15ceef2a38b28e2c0c3bd.html#aef9a60e9d1c15ceef2a38b28e2c0c3bd">skyrate</a>[ext];
<a name="l00204"></a>00204                                 i++;
<a name="l00205"></a>00205                         }
<a name="l00206"></a>00206                 }
<a name="l00207"></a>00207                 <a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[ext]=<a class="code" href="calculate_8cpp_aca87034f5f258906fac666feb24c63de.html#aca87034f5f258906fac666feb24c63de">GetMedian</a>(arr,<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>);
<a name="l00208"></a>00208                 temp=temp+<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[ext];
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         temp=temp/MaxChipInstalled;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00214"></a>00214                 (<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>)[ext]=(<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>)[ext]/temp;
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216         free(arr);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="preprocessor">        #ifdef DEBUG</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;Finishing QE ration calculation. %f, %f, %f, %f\n&quot;</span>,<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[0],<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[1],<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[2],<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[3]);
<a name="l00220"></a>00220 <span class="preprocessor">        #endif</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="comment">/* This function will calculate corrected sky level (ADU/pixel/sec)</span>
<a name="l00225"></a>00225 <span class="comment"> *  based on QE ratio</span>
<a name="l00226"></a>00226 <span class="comment"> */</span>
<a name="l00227"></a><a class="code" href="class_sky_background_a158b0f5bd048727c6583bfae9609081d.html#a158b0f5bd048727c6583bfae9609081d">00227</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_a158b0f5bd048727c6583bfae9609081d.html#a158b0f5bd048727c6583bfae9609081d">SkyBackground::correctSkyLevel</a>(){
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <span class="keywordtype">int</span> i,ext,slice,fits;
<a name="l00230"></a>00230         <span class="keywordtype">double</span> temp=0,sum=0;
<a name="l00231"></a>00231         <span class="keywordtype">double</span> mean;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>=(<span class="keywordtype">double</span> *)malloc(<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00234"></a>00234         <a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>=(<span class="keywordtype">double</span> *)malloc(<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="comment">/* Correct sky level using QE ratio */</span>
<a name="l00237"></a>00237         i=0;
<a name="l00238"></a>00238         <span class="keywordflow">for</span> (fits=0;fits&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;fits++){
<a name="l00239"></a>00239                 <span class="keywordflow">for</span> (slice=0;slice&lt;<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;slice++){
<a name="l00240"></a>00240                         temp=0;
<a name="l00241"></a>00241                         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00242"></a>00242                                 temp+=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a83b2c1bbcdf13ce05854d06585ccae5a.html#a83b2c1bbcdf13ce05854d06585ccae5a" title="This function is used to get the sky level of each frame.">getImageMedian</a>()[slice].<a class="code" href="structskybackground__t_aef9a60e9d1c15ceef2a38b28e2c0c3bd.html#aef9a60e9d1c15ceef2a38b28e2c0c3bd">skyrate</a>[ext]/<a class="code" href="class_sky_background_aa0a344266cfda88544c73793300b2ba5.html#aa0a344266cfda88544c73793300b2ba5">qeratio</a>[ext];
<a name="l00243"></a>00243                         }
<a name="l00244"></a>00244                         <a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>[i]=temp/MaxChipInstalled;
<a name="l00245"></a>00245                         sum=sum+<a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>[i];
<a name="l00246"></a>00246                         i++;
<a name="l00247"></a>00247                 }
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         mean=sum/<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>;
<a name="l00251"></a>00251         printf(<span class="stringliteral">&quot;mean=%f\n&quot;</span>,mean);
<a name="l00253"></a>00253         <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>;i++){
<a name="l00254"></a>00254                 (<a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>)[i]=<a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>[i]/mean;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00262"></a><a class="code" href="class_sky_background_aa14532b4cf9575c9f549128b737a1592.html#aa14532b4cf9575c9f549128b737a1592">00262</a> <span class="keywordtype">void</span> <a class="code" href="class_sky_background_aa14532b4cf9575c9f549128b737a1592.html#aa14532b4cf9575c9f549128b737a1592" title="Building sky image.">SkyBackground::buildSkyImage</a>(){
<a name="l00263"></a>00263         <span class="keywordtype">int</span> fits,ext,slice,offset,j,nslice,i=0;
<a name="l00264"></a>00264         <span class="keywordtype">double</span> arr[<a class="code" href="class_sky_background_a25de73bef372fd9abf9bc166c612369a.html#a25de73bef372fd9abf9bc166c612369a">TotalFrameNumber</a>];
<a name="l00265"></a>00265         <span class="keywordtype">double</span> temp[<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize];
<a name="l00266"></a>00266         <span class="keywordtype">double</span> value,med,factor;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         offset=<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="comment">/* Correcting sky variance*/</span>
<a name="l00271"></a>00271         <span class="keywordflow">for</span> (fits=0;fits&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;fits++){
<a name="l00272"></a>00272                 nslice=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
<a name="l00273"></a>00273                 <span class="keywordflow">for</span> (slice=0;slice&lt;nslice;slice++){
<a name="l00274"></a>00274                         factor=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_a07f6264ce16923314276990bf5d4898d.html#a07f6264ce16923314276990bf5d4898d" title="Exposure time.">exptime</a>*<a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>[i];
<a name="l00275"></a>00275                         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00280"></a>00280                                 <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
<a name="l00281"></a>00281                                         value=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a5d453cb18689cc8264fe941a13901be1.html#a5d453cb18689cc8264fe941a13901be1">getImageArrayValue</a>((ext*nslice+slice)*offset+j)/factor;
<a name="l00282"></a>00282                                         <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a059d8d62a754e6f33ff3fd8b3d521671.html#a059d8d62a754e6f33ff3fd8b3d521671">setImageArrayValue</a>((ext*nslice+slice)*offset+j,value);
<a name="l00283"></a>00283                                 }
<a name="l00284"></a>00284                         }
<a name="l00285"></a>00285                         <span class="comment">//printf(&quot;I=%i SKYLVL=%f exp=%f fac=%f\n&quot;,i,skylvl_var[i],DetrendImage[fits].getImageHeader().exptime,factor);</span>
<a name="l00286"></a>00286                         i++;
<a name="l00287"></a>00287                 }
<a name="l00288"></a>00288         }
<a name="l00290"></a>00290         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00291"></a>00291                 <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
<a name="l00292"></a>00292                         i=0;
<a name="l00293"></a>00293                         <span class="keywordflow">for</span> (fits=0;fits&lt;nSkyFITS;fits++){
<a name="l00294"></a>00294                                 nslice=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a28eb3eff24689c4cc458d6e1206829bc.html#a28eb3eff24689c4cc458d6e1206829bc" title="Return a image array of FITS file.">getImageHeader</a>().<a class="code" href="struct_image_info_ad131f2d7aca673a30b88400499bface9.html#ad131f2d7aca673a30b88400499bface9" title="Dimension of Z-axis or time sequence.">naxis3</a>;
<a name="l00296"></a>00296                                 <span class="keywordflow">for</span> (slice=0;slice&lt;nslice;slice++){
<a name="l00300"></a>00300                                         <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].getImageArrayValue((ext*nslice+slice)*offset+j) &lt;= 0){<span class="keywordflow">continue</span>;}
<a name="l00301"></a>00301                                         arr[i]=<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[fits].<a class="code" href="class_image_a5d453cb18689cc8264fe941a13901be1.html#a5d453cb18689cc8264fe941a13901be1">getImageArrayValue</a>((ext*nslice+slice)*offset+j);
<a name="l00302"></a>00302                                         i++;
<a name="l00303"></a>00303                                 }
<a name="l00304"></a>00304                         }
<a name="l00305"></a>00305                         <span class="keywordflow">if</span> (i == 0 ){
<a name="l00306"></a>00306                                 <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[ext*offset+j]=0;
<a name="l00307"></a>00307                         } <span class="keywordflow">else</span> {
<a name="l00308"></a>00308                                 <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[ext*offset+j]=<a class="code" href="calculate_8cpp_aca87034f5f258906fac666feb24c63de.html#aca87034f5f258906fac666feb24c63de">GetMedian</a>(arr,i);
<a name="l00309"></a>00309                         }
<a name="l00310"></a>00310                 }
<a name="l00311"></a>00311         }
<a name="l00313"></a>00313         <span class="keywordflow">for</span> (ext=0;ext&lt;MaxChipInstalled;ext++){
<a name="l00314"></a>00314                 offset=ext*<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;
<a name="l00315"></a>00315                 <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
<a name="l00316"></a>00316                         temp[j]=<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j];
<a name="l00317"></a>00317                 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                 med=<a class="code" href="calculate_8cpp_aca87034f5f258906fac666feb24c63de.html#aca87034f5f258906fac666feb24c63de">GetMedian</a>(temp,<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 <span class="preprocessor">                #ifdef DEBUG</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;med=%f\n&quot;</span>,med);
<a name="l00323"></a>00323 <span class="preprocessor">                #endif</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>
<a name="l00325"></a>00325                 <span class="comment">/* Normalize sky background to unity */</span>
<a name="l00326"></a>00326                 <span class="keywordflow">for</span> (j=0;j&lt;<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize;j++){
<a name="l00327"></a>00327                         <span class="keywordflow">if</span> (isnan(<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]) ||<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j] &lt;= 0){
<a name="l00328"></a>00328                                 <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]=nanf(<span class="stringliteral">&quot;NaN&quot;</span>);
<a name="l00329"></a>00329                         }
<a name="l00330"></a>00330                         <span class="keywordflow">else</span>{
<a name="l00331"></a>00331                                 <a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]=<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[offset+j]/med;
<a name="l00332"></a>00332                         }
<a name="l00333"></a>00333                 }
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="class_sky_background_a0149941a484570d87b3ef9673a5f429c.html#a0149941a484570d87b3ef9673a5f429c">00341</a> <span class="keywordtype">int</span> <a class="code" href="class_sky_background_a0149941a484570d87b3ef9673a5f429c.html#a0149941a484570d87b3ef9673a5f429c">SkyBackground::writeSkyBackgroundImage</a>(<span class="keywordtype">char</span>* filename){
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     fitsfile *fptr;       <span class="comment">/* pointer to the FITS file, defined in fitsio.h */</span>
<a name="l00344"></a>00344     <span class="keywordtype">int</span> status=0,hdupos,i,fits;
<a name="l00345"></a>00345     <span class="keywordtype">long</span>  nelements;
<a name="l00346"></a>00346     <span class="keywordtype">float</span> array[<a class="code" href="imparameter_8h_ad9853697a7a042636b0fdfef4d489ada.html#ad9853697a7a042636b0fdfef4d489ada">MaxImageXSize</a>*MaxImageYSize];
<a name="l00347"></a>00347     <span class="keywordtype">string</span> string;
<a name="l00349"></a>00349     <span class="keywordtype">long</span> naxes[9] = {1, 1, 1, 1, 1, 1, 1, 1, 1};
<a name="l00350"></a>00350     <span class="keywordtype">char</span> skykey[80];
<a name="l00351"></a>00351 
<a name="l00353"></a>00353     <span class="keyword">remove</span>(filename);
<a name="l00354"></a>00354 
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (fits_create_file(&amp;fptr, filename, &amp;status))
<a name="l00357"></a>00357          printf(<span class="stringliteral">&quot;Error on creating file. status=%i\n&quot;</span>,status );
<a name="l00358"></a>00358 
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (fits_movabs_hdu(<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[0].getInputFITSptr(), 1, NULL, &amp;status)){
<a name="l00361"></a>00361                 printf(<span class="stringliteral">&quot;status=%i\n&quot;</span>,status );
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363         fits_copy_header(<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[0].getInputFITSptr(), fptr, &amp;status);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">for</span> (hdupos=2; hdupos&lt;=5; hdupos++){
<a name="l00366"></a>00366                 fits_movabs_hdu(<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[0].getInputFITSptr(), hdupos, NULL, &amp;status);
<a name="l00367"></a>00367                 fits_copy_header(<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>[0].getInputFITSptr(),fptr, &amp;status);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 <span class="comment">/* Update important FITS keywords */</span>
<a name="l00370"></a>00370                 fits_modify_key_lng(fptr,<span class="stringliteral">&quot;NAXIS3&quot;</span>,1,NULL,&amp;status);
<a name="l00371"></a>00371                 fits_modify_key_lng(fptr,<span class="stringliteral">&quot;BITPIX&quot;</span>,FLOAT_IMG,NULL,&amp;status);
<a name="l00372"></a>00372                 fits_modify_key_lng(fptr,<span class="stringliteral">&quot;BZERO&quot;</span>,0,NULL,&amp;status);
<a name="l00373"></a>00373                 fits_modify_key_lng(fptr,<span class="stringliteral">&quot;CHIPBIAS&quot;</span>,0,NULL,&amp;status);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375                 fits_update_key_lng(fptr,<span class="stringliteral">&quot;N_ODOSKY&quot;</span>,<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>,<span class="stringliteral">&quot;Nbr of odometers used in constructing sky&quot;</span>,&amp;status);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                 <span class="keywordflow">for</span> (fits=0;fits&lt;<a class="code" href="class_sky_background_af6cb6b2965ade33e6354a1c263f7ac91.html#af6cb6b2965ade33e6354a1c263f7ac91">nSkyFITS</a>;fits++){
<a name="l00378"></a>00378                         <span class="keywordtype">string</span>=this-&gt;<a class="code" href="class_sky_background_a5a571e4c32175c9cf5a243460f2d16fa.html#a5a571e4c32175c9cf5a243460f2d16fa" title="getting the name of detrended FITS file based on array index">getDetrendFile</a>(fits);
<a name="l00379"></a>00379                         sprintf(skykey,<span class="stringliteral">&quot;%s%02d&quot;</span>,<span class="stringliteral">&quot;ODOSKY&quot;</span>,fits+1);
<a name="l00380"></a>00380                         fits_update_key_str(fptr,skykey,(<span class="keywordtype">char</span> *)<span class="keywordtype">string</span>.substr(<span class="keywordtype">string</span>.find_last_of(<span class="stringliteral">&quot;/&quot;</span>)+1).c_str(),
<a name="l00381"></a>00381                                         <span class="stringliteral">&quot;Odometers used for sky construction&quot;</span>,&amp;status);
<a name="l00382"></a>00382                 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                 naxes[0]=MaxImageXSize;
<a name="l00385"></a>00385                 naxes[1]=MaxImageYSize;
<a name="l00386"></a>00386                 naxes[2]=1;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         nelements = naxes[0] * naxes[1] * naxes[2];
<a name="l00389"></a>00389                 <span class="comment">/* initialize the values  */</span>
<a name="l00390"></a>00390                 <span class="keywordflow">for</span> (i=0;i&lt;nelements;i++){
<a name="l00391"></a>00391                         array[i]=<a class="code" href="class_sky_background_aaf1b0c6e824eedcd2e7ece9d2e891f09.html#aaf1b0c6e824eedcd2e7ece9d2e891f09">skyBackgroundImage</a>[(hdupos-2)*nelements+i];
<a name="l00392"></a>00392                 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394                 <span class="comment">/* write the array of unsigned integers to the FITS file */</span>
<a name="l00395"></a>00395                 <span class="keywordflow">if</span> ( fits_write_img(fptr, TFLOAT, 1, nelements, array, &amp;status) )
<a name="l00396"></a>00396                         printf(<span class="stringliteral">&quot;status=%i\n&quot;</span>,status );
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (fits_close_file(fptr, &amp;status)){
<a name="l00401"></a>00401         printf(<span class="stringliteral">&quot;status=%i\n&quot;</span>,status );
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">return</span> EXIT_SUCCESS;
<a name="l00405"></a>00405 }
<a name="l00409"></a><a class="code" href="class_sky_background_a851efe362ae56e4f68184adc0f06708e.html#a851efe362ae56e4f68184adc0f06708e">00409</a> <a class="code" href="class_sky_background_a851efe362ae56e4f68184adc0f06708e.html#a851efe362ae56e4f68184adc0f06708e" title="Default constructor.">SkyBackground::SkyBackground</a>(){}
<a name="l00410"></a>00410 
<a name="l00414"></a><a class="code" href="class_sky_background_a97bae057fbff40d0a1755e9808ff8928.html#a97bae057fbff40d0a1755e9808ff8928">00414</a> <a class="code" href="class_sky_background_a851efe362ae56e4f68184adc0f06708e.html#a851efe362ae56e4f68184adc0f06708e" title="Default constructor.">SkyBackground::SkyBackground</a>(<span class="keywordtype">char</span>* list){
<a name="l00415"></a>00415         this-&gt;<a class="code" href="class_sky_background_a1ff3d7d529d8d7cbdee5e9e3c317ca36.html#a1ff3d7d529d8d7cbdee5e9e3c317ca36" title="Set the file list for skybackground.">setFileList</a>(list);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 }
<a name="l00421"></a><a class="code" href="class_sky_background_a6f67098502bb2edab87b45ed6dad5e9b.html#a6f67098502bb2edab87b45ed6dad5e9b">00421</a> <a class="code" href="class_sky_background_a851efe362ae56e4f68184adc0f06708e.html#a851efe362ae56e4f68184adc0f06708e" title="Default constructor.">SkyBackground::SkyBackground</a>(<span class="keywordtype">char</span>* list, <span class="keywordtype">char</span>* masklist){
<a name="l00423"></a>00423         this-&gt;<a class="code" href="class_sky_background_a1ff3d7d529d8d7cbdee5e9e3c317ca36.html#a1ff3d7d529d8d7cbdee5e9e3c317ca36" title="Set the file list for skybackground.">setFileList</a>(list);
<a name="l00424"></a>00424 
<a name="l00426"></a>00426         this-&gt;<a class="code" href="class_sky_background_adac86077fdc277287ed3809e6c54ffcc.html#adac86077fdc277287ed3809e6c54ffcc" title="Set the file list for bad pixel mask.">setMaskList</a>(masklist);
<a name="l00427"></a>00427 
<a name="l00429"></a>00429         <a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>=NULL;
<a name="l00430"></a>00430         <a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>=NULL;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="class_sky_background_a90e0f18376871dd8e72b1b06b263c3b3.html#a90e0f18376871dd8e72b1b06b263c3b3">00434</a> <a class="code" href="class_sky_background_a90e0f18376871dd8e72b1b06b263c3b3.html#a90e0f18376871dd8e72b1b06b263c3b3">SkyBackground::~SkyBackground</a>(){
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a> != NULL){
<a name="l00436"></a>00436                 <span class="keyword">delete</span> [] <a class="code" href="class_sky_background_acd6e5c8bc24dbc4f30009da92605d74c.html#acd6e5c8bc24dbc4f30009da92605d74c">DetrendImage</a>;
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438         <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a> != NULL){
<a name="l00439"></a>00439                 free(<a class="code" href="class_sky_background_a39cdedaff3f4d8fba64baf48975c2ffd.html#a39cdedaff3f4d8fba64baf48975c2ffd">skylvl_corrmean</a>);
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441         <span class="keywordflow">if</span> (<a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a> != NULL){
<a name="l00442"></a>00442                 free(<a class="code" href="class_sky_background_a1759b22ba1160199070d8b1aad43a4a3.html#a1759b22ba1160199070d8b1aad43a4a3">skylvl_var</a>);
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Fri Jul 22 2011 20:18:24 for Akepa by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
